<!DOCTYPE html>
<html>

<head>
  <title>SVG.js</title>
  <script type="text/javascript" src="svg.min.js"></script>
</head>

<body>
  <div id="drawing"></div>
  <script type="text/javascript">
    var blocksByHeight = {}

    blocksByHeight['1'] = [{ id: '1', height: 1, owners: ['A', 'B'] }]
    blocksByHeight['2'] = [{ id: '2', height: 2, owners: ['A', 'B'], parent: '1' }]
    blocksByHeight['3'] = [
      { id: '3', height: 3, owners: ['A', 'B'], parent: '2' },
      { id: '3!', height: 3, owners: ['C'], parent: '2' },
    ]
    blocksByHeight['4'] = [{ id: '4', height: 4, owners: ['A', 'B'], parent: '3' }]
    blocksByHeight['5'] = [{ id: '5', height: 5, owners: ['A', 'B'], parent: '4' }]
    blocksByHeight['6'] = [
      { id: '6A', height: 6, owners: ['C'], parent: '5' },
      { id: '6B', height: 6, owners: ['E'], parent: '5' },
      { id: '6C', height: 6, owners: ['D'], parent: '5' }
    ]
    blocksByHeight['7'] = [{ id: '7', height: 7, owners: ['A', 'B'], parent: '6A' }]

    var rowHeight = 10
    var dotRadius = 5
    var draw = SVG('drawing').size('500', '500')
    var branches = []
    var box = draw.viewbox(0, 0, 500, 500)

    var colors = ['red', 'green', 'blue']

    function numberRange(start, end) {
      return new Array(end - start).fill().map((d, i) => i + start);
    }

    function renderBlock(block) {
      var branch = branches.filter(br => br.youngestBlock == block.id)
      if (branch.length == 0) {
        var b = {
          position: branches.length,
          color: colors[branches.length],
          youngestBlock: block.parent
        }
        branches.push(b)
        return { color: b.color, position: b.position }
      }
      else {
        var b = branch[0]
        b.youngestBlock = block.parent
        return { color: b.color, position: b.position }
      }
    }

    function render(from, to, blocksByHeight) {
      branches = []
      box.clear()
      var h = 0

      for (var i = to; i >= from && i > 0; i--) {
        blocks = blocksByHeight[i]
        if (blocks) {
          Object.keys(blocks).map(b => blocks[b]).forEach(b => {
            var r = renderBlock(b)
            var rect2 = box.rect(dotRadius, dotRadius).move(r.position * rowHeight, h).attr({ fill: r.color })
            box.text(b.id).move(r.position * rowHeight + rowHeight, h).font({ size: 6 })
          })
        }
        h += rowHeight
      }
    }

    if ("WebSocket" in window) {
      var ws = new WebSocket("ws://localhost:8080/");

      ws.onopen = function () {
      };

      ws.onmessage = function (evt) {
        var data = evt.data
        blocksByHeight = JSON.parse(data)
        var keys = Object.keys(blocksByHeight)
        var maxH = keys[keys.length - 1]
        console.log("new data: maxH => " + maxH)
        render(maxH - 50, maxH, blocksByHeight)
      };

      ws.onclose = function () {
      };

      window.onbeforeunload = function (event) {
        socket.close()
      };
    }

  </script>
</body>

</html>